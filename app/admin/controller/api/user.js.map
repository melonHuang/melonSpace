{
    "version": 3,
    "sources": [
        "../../../../src/admin/controller/api/user.js"
    ],
    "names": [
        "getAction",
        "self",
        "where",
        "modelInstance",
        "field",
        "id",
        "find",
        "user",
        "success",
        "get",
        "status",
        "type",
        "_logic",
        "select",
        "users",
        "model",
        "setRelation",
        "group",
        "posts",
        "postsNum",
        "map",
        "user_id",
        "post_num",
        "commentsNum",
        "comment_num",
        "forEach",
        "postAction",
        "generateKey",
        "data",
        "post",
        "addUser",
        "ip",
        "insertId",
        "isAdmin",
        "userInfo",
        "firekylin",
        "USER_ADMIN",
        "failed",
        "app_key",
        "think",
        "uuid",
        "app_secret",
        "getOptions",
        "options",
        "transporter",
        "createTransport",
        "site_url",
        "hasOwnProperty",
        "http",
        "host",
        "sendMail",
        "from",
        "to",
        "email",
        "subject",
        "title",
        "text",
        "putAction",
        "fail",
        "saveUser",
        "rows",
        "affectedRows"
    ],
    "mappings": "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",
    "file": "../../../../src/admin/controller/api/user.js",
    "sourcesContent": [
        "'use strict';\n\nimport Base from './base.js';\nimport nodemailer from 'nodemailer';\n\nexport default class extends Base {\n  /**\n   * get\n   * @return {[type]} [description]\n   */\n  async getAction(self){\n    let where = {};\n    let modelInstance = this.modelInstance.field('id,name,display_name,email,type,status,create_time,last_login_time,app_key,app_secret');\n    \n    if( this.id ) {\n      where.id = this.id;\n      let user = await modelInstance.where(where).find();\n      return this.success(user);\n    }\n\n    if(this.get('type') === 'contributor') {\n      where = {status: 2, type: 3};\n    } else {\n      where = {status: ['!=', 2], type: ['!=', 3], _logic: 'OR'};\n    }\n\n    let users = await modelInstance.where(where).select();\n    let posts = await this.model('post').field('user_id, COUNT(*) as post_num, SUM(comment_num) as comment_num').setRelation(false).group('user_id').select();\n    let postsNum = new Map( posts.map(({user_id, post_num}) => [user_id, post_num]) );\n    let commentsNum = new Map( posts.map(({user_id, comment_num}) => [user_id, comment_num]) );\n\n    users.forEach(user => {\n      user.post_num = postsNum.get(user.id) || 0; \n      user.comment_num = commentsNum.get(user.id) || 0;\n    });\n\n    return this.success(users);\n  }\n  /**\n   * add user\n   * @return {[type]} [description]\n   */\n  async postAction(self){\n    if( this.get('type') === 'key' ) {\n      return await this.generateKey(self);\n    }\n\n    let data = this.post();\n    let insertId = await this.modelInstance.addUser(data, this.ip());\n    return this.success({id: insertId});\n  }\n\n  async generateKey(self, status) {\n    let isAdmin = this.userInfo.type === firekylin.USER_ADMIN;\n    // let isMine = this.userInfo.id === this.id;\n    if( !isAdmin ) {\n      return this.failed();\n    }\n\n    let app_key = think.uuid();\n    let app_secret = think.uuid();\n\n    await this.modelInstance.generateKey(this.id, app_key, app_secret, status);\n    //TODO: 增加邮件发送 app_key 和 app_secret 的功能\n    let user = await this.modelInstance.where({id: this.id}).find();\n    let options = await this.model('options').getOptions();\n    let transporter = nodemailer.createTransport();\n    let site_url = options.hasOwnProperty('site_url') ? options.site_url : `http://${http.host}`;\n    transporter.sendMail({\n      from: 'no-reply@firekylin.org',\n      to: user.email,\n      subject: `【${options.title}】网站推送申请成功`,\n      text: `你的推送申请审批通过，请将下面的信息添加到自己的博客中完成最后的推送操作。\n        网站名称：${options.title}\n        网站地址：${site_url}\n        app_key: ${app_key}\n        app_secret: ${app_secret}\n      `\n    });\n\n\n    if(status != null) { this.id = null; }\n    return await this.getAction(self);\n  }\n  /**\n   * update user info\n   * @return {[type]} [description]\n   */\n  async putAction(self){\n    let type = this.get('type');\n\n    if (!this.id) {\n      return this.fail('PARAMS_ERROR');\n    }\n\n    if(type === 'contributor') {\n      return await this.generateKey(self, 1);\n    }\n    \n    let data = this.post();\n    data.id = this.id;\n    let rows = await this.modelInstance.saveUser(data, this.ip());\n    return this.success({affectedRows: rows});\n  }\n}\n"
    ]
}